# Log设计

## 功能需求

1. 日志消息可以有多个目的地，除了能打印到控制台， 还可以输出到文件等
2. 日志内容应该可以做格式化， 例如变成纯文本，XML, HTML格式等等
3. 可以设置运行时过滤器，对于不同的组件，应该可以设置不同的日志级别和文件
4. 能对日志进行分级， 应该有trace、debug、info、warn、error、fatal等级别
5. 应该能在所有情况下都能记录日志



## 需要考虑的问题

1. 是否应该有多线程写入？如果有多线程写入如何保证写入顺序？

2. 如何设计缓冲区保证写入速度？

3. 日志中需要反复读取时间，如何进行优化？

   

## 回答

1、没有多线程写入，多线程写入可能并不能提速，有可能受限于硬盘写入速度，并且会带来并行问题，单个进程就只有一个写入线程

2、使用双缓冲区保证写入速度，使用区分前后端两个缓存，前端缓存负责从其他线程收集log，后端缓存负责提供给写入线程进行写入，把快的线程和慢的线程使用的缓存进行分离，避免因为写入过慢阻塞



## 具体设计

### FileUtil

底层文件类，封装了log文件的打开、写入并在类析构的时候关闭文件，底层使用了标准IO

构造函数：

- 参数：log文件存储位置

对外提供

- append：追加内容
- flush：清空缓冲

### LogFile

对FileUtil进一步封装，添加了flush间隔次数，达到上限后会flush

构造函数：

- 参数：log文件存储位置，flush间隔次数

对外提供

- append：追加内容

- flush：清空缓冲

- rollFile：切换到循环写入（未完成）

  

### AsyncLogger

日志核心类，内部会启动一个线程负责写入，使用了双缓存技术，定时或者定量把数据输入到Logfile中

构造函数：

- 参数：log文件存储位置，flush时间间隔（默认值两秒）

对外提供

- append：追加内容

- start：启动写入线程

- stop：停止线程，并完成所有的写入

  

### LogStream

格式化，重载了<<，同时也有自己的一块缓冲区，这是为了缓存一行，把多个<<的结果连成一块。

构造函数：

- 无参数：

对外提供

- <<：用于输出各种数据
- buffer：用于获取内部buffer，进行输出



### FixedBuffer

辅助类，用于表示缓存，使用了非类型模板参数

构造函数：

- 无参数：但需要使用非类型模板参数指定内部缓存大小

对外提供

- avail：可用空间
- append：追加数据到buff中
- data：获取内部buff数据
- length：获取buff数据长度
- current：buff中当前数据末尾指针
- add：移动数据末尾指针
- reset：把数据末尾指针移动到buff开头
- resetData：对buff全部清零



### Logger

Logging是对外接口，Logging类内涵一个LogStream对象，主要是为了每次打log的时候在log之前和之后加上固定的格式化的信息，比如打log的行、文件名等信息。

构造函数：

- 参数：log文件存储位置，line程序执行代码位置

对外提供

- stream：获取输出流
- getLogetFileName：获取位置存储位置
- setLogFileName：设置文件存储位置
- ~Looger：析构时将数据输出到LogStream

